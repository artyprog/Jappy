<code-editor>

<style type="text/css">
code-editor {
  display: flex;
  flex: 1 1;
}
.ace_editor {
    width: 100%;
    font-size: 16pt;
    font-family: "DejaVu Sans Mono", monospace;
    flex: 1 1;
}
.ace_error-marker{
    border: 1px solid red;
}
iframe {
    border: 0px;
    display: none;
    flex: 1 1;
}
hr {
    border: 3px solid #808080;
    padding : 0px;
    border: 0px;
    margin: 0px;
}
.split {
    display: flex;
    flex-direction: column;
    flex: 1 1;
}
.vsplit {
    display: flex;
    flex-direction: row;
    flex: 1 1;
}
.tabs button {
    border-radius: 0;
    padding: 10px;
    border: 0px;
}
.tabs button.selected {
    background-color: #282828;
}
</style>

<div class='vsplit'>
    <div class='split'>
        <div class='tabs'>
        <button each={name in list(files)}
                class={selected: name==parent.title}
                onclick={ parent.switchtab }>{str(name)}</button>
        </div>
        <div ref="code"></div>
    </div>
    <div ref="hr"><hr></div>
    <iframe ref="vmframe" src="template.html"></iframe>
</div>

<script type="text/Rapyd">

print('RapydScript-ng ' + RapydScript.rs_version)

tag = this
this.marker = None
window.files = {}

def compile(editor):
    session = editor.getSession()
    if tag.marker:
        session.removeMarker(tag.marker)

    try:
        result = compiler.compile(editor.getValue())
        if "print;" in result:
            raise SyntaxError('Missing parentheses in call to "print"')

    except Exception as e:
        code = "print ('''" + e.name + ": " + e.message + "''')"
        if e.line and e.col:
            Range = ace.require('ace/range').Range
            tag.marker = session.addMarker(
                    new Range(e.line-1, e.col, e.line-1, e.col+1),
                                "ace_error-marker", "text")
        result = compiler.compile(code)
    return result

def init():
    editor = ace.edit(this.refs.code)
    editor.setTheme("ace/theme/solarized_light")
    edit_session = editor.getSession()
    edit_session.setNewLineMode("unix");
    edit_session.setMode("ace/mode/python")
    editor.$blockScrolling = Infinity
    iframe = this.refs.vmframe
    EditSession = ace.require('ace/edit_session').EditSession

    def load_datastore(activity):
        datastore = activity.getDatastoreObject()
        def check_load(error, metadata, data):
            tag.title = 'untitled.pyj'
            if (data):
                edit_session.setValue(data)
                tag.title = metadata.title
            window.files = {tag.title: edit_session}
            tag.update()
        datastore.loadAsText(check_load)
        window.activity = activity
    event_bus.on("activity-ready", load_datastore)

    def switchtab(e):
        tag.title = e.target.innerHTML
        editor.setSession(window.files[e.target.innerHTML])
    tag.switchtab = switchtab

    def toggle_tray(show=False):
        if show==True or getComputedStyle(iframe).display == 'none':
            iframe.style.display='block'
            iframe.style.width='100%'
            event_bus.trigger("traybutton-close")
        else:
            iframe.style.display='none'
            event_bus.trigger("traybutton-open")
        editor.resize()
    event_bus.on("toggle-tray", toggle_tray)
    this.refs.hr.onclick = toggle_tray

    def run():
        if window.activity:
            event_bus.trigger("activity-save", activity)
        toggle_tray(True)
        js_output = compile(editor)
        script = iframe.contentDocument.createElement('script')
        script.innerHTML = js_output
        def write_script():
            iframe.contentDocument.body.appendChild(script)
            iframe.contentDocument.close()
        iframe.onload = write_script
        iframe.contentWindow.location = 'template.html'
    event_bus.on("run-code", run)

    def break_code():
        iframe.contentWindow.stop()
    event_bus.on("break-code", break_code)

    def clear_output():
        iframe.contentWindow.location = 'about:blank'
    event_bus.on("clear-output", clear_output)

    def save(activity):
        datastore = activity.getDatastoreObject()
        datastore.setDataAsText(edit_session.getValue())
        def check_save(error):
            if error is None:
                console.log("Saved")
            else:
                console.log("NOT Saved")
        datastore.save(check_save)
    event_bus.on("activity-save", save)

    def example_load(file):
        fetch('examples/'+file).then(
            def(response):
                if (response.ok):
                    response.text().then(def(data):
                        new_session = new EditSession(data)
                        new_session.setNewLineMode("unix");
                        new_session.setMode("ace/mode/python")
                        files[file] = new_session
                        editor.setSession(new_session)
                        tag.title = file
                        tag.update()
                    )
                else:
                    error = new Error(response.statusText)
                    error.response = response
                    raise error
        )
    event_bus.on("example-load", example_load)

    editor.commands.removeCommand('gotoline') # Conflicts with browser hotkey
    editor.commands.addCommand({
            'name': 'Run',
            'bindKey': {'win': 'Ctrl-Enter',  'mac': 'Command-Enter'},
            'exec': run})

    this.editor = editor
    window.editor = editor

this.on('mount', init)

</script>
</code-editor>
