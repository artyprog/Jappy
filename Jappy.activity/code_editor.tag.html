<code-editor>

<style type="text/css">
code-editor {
  display: flex;
  flex: 1 1;
}
.ace_editor {
    width: 100%;
    font-size: 16pt;
    font-family: "DejaVu Sans Mono", monospace;
    flex: 1 1;
}
.ace_error-marker{
    border: 1px solid red;
}
iframe {
    border: 0px;
    display: none;
    flex: 1 1;
}
hr {
    border: 3px solid #808080;
    padding : 0px;
    border: 0px;
    margin: 0px;
}
#split {
    display: flex;
    flex-direction: column;
    flex: 1 1;
}
#vsplit {
    display: flex;
    flex-direction: row;
    flex: 1 1;
}
.tabs button {
    border-radius: 0;
    padding: 10px 10px;
    border: 0px;
    margin: 0px;
}
.tabs button.selected {
    background-color: #282828;
}
#closetab {
    background-image: url(lib/sugar-web/graphics/icons/actions/entry-cancel-active.svg);
    background-repeat: no-repeat;
    background-color: #282828;
    width: 28px;
    background-position: center;
    background-size: 16px 16px;
}
#closetab:active {
    background-image: url(lib/sugar-web/graphics/icons/actions/entry-cancel.svg);
}
#newtab {
    background-image: url(icons/tab-add.svg);
    background-repeat: no-repeat;
    width: 28px;
    background-position: center;
    background-size: 20px 20px;
}
</style>

<div id='vsplit' ref='vsplit'>
    <div id='split' ref='split'>
        <div class='tabs'>
        <button onclick={ this.newtab } id='newtab'>&nbsp;</button><!--
        --><span each={name in list(files)}><!--
        --><button class={selected: name==parent.title}
                    onclick={ parent.switchtab }>{str(name)}</button><!--
        --><button if={ name==parent.title && len(files)>1 } id='closetab'
            onclick={ parent.closetab }>&nbsp;</button></span>
        </div>
        <div ref="code"></div>
    </div>
    <div ref="hr"><hr></div>
    <iframe allowTransparency="false" ref="vmframe" src="template.html"></iframe>
</div>

<script type="text/Rapyd">

print('RapydScript-ng ' + RapydScript.rs_version)

tag = this
this.marker = None
window.files = {}

def compile(inputcode=None):
    editor = window.editor
    options = {'basedir':'__stdlib__',
               'bare': True,
               'omit_baselib':True}

    for file in window.files:
        if file is not tag.title:
            RapydScript.file_data['__stdlib__/' + file] = window.files[file].getValue()

    session = editor.getSession()
    if tag.marker and not inputcode:
        session.removeMarker(tag.marker)

    try:
        result = RapydScript.compile(inputcode or editor.getValue(), tag.title, options)
        if "print;" in result:
            raise SyntaxError('Missing parentheses in call to "print"')

    except Exception as e:
        console.log(e)
        code = "print ('''" + e.name + ": " + e.message + "''')"
        if e.line and e.col and not inputcode:
            Range = ace.require('ace/range').Range
            tag.marker = session.addMarker(
                    new Range(e.line-1, e.col, e.line-1, e.col+1),
                                "ace_error-marker", "text")
        result = compiler.compile(code)
    return result
window.compile = compile

def init():
    editor = ace.edit(this.refs.code)
    editor.setTheme("ace/theme/solarized_light")
    edit_session = editor.getSession()
    edit_session.setNewLineMode("unix");
    edit_session.setMode("ace/mode/python")
    editor.$blockScrolling = Infinity
    iframe = this.refs.vmframe

    def load_datastore(activity):
        datastore = activity.getDatastoreObject()
        def check_load(error, metadata, data):
            if (data):
                try:
                    parsed_data = JSON.parse(data)
                except SyntaxError:
                    # Early versions saved single files
                    parsed_data = { get_new_untitled(): data }
                for file in parsed_data:
                    if parsed_data[file]:
                        new_session = ace.createEditSession(parsed_data[file])
                        new_session.setNewLineMode("unix");
                        new_session.setMode("ace/mode/python")
                        window.files[file] = new_session
            if len(window.files) > 0:
                tag.title = list(parsed_data)[0]
                editor.setSession(window.files[tag.title])
            else:            
                tag.title = get_new_untitled()
                window.files = {tag.title: edit_session}
            tag.update()
        datastore.loadAsText(check_load)
        window.activity = activity
    event_bus.on("activity-ready", load_datastore)

    def make_do():
        tag.title = get_new_untitled()
        window.files = {tag.title: edit_session}
        tag.update()
    event_bus.on("activity-not-ready", make_do)

    def switchtab(e):
        if tag.title is not e.target.innerHTML:
            tag.title = e.target.innerHTML
            editor.setSession(window.files[e.target.innerHTML])
            editor.focus()
        else:
            e.target.style.display = 'none'
            editbox = document.createElement('input')
            editbox.value = tag.title
            def rename_tab():
                if editbox.value not in window.files:
                    window.files[editbox.value] = editor.getSession()
                    del window.files[tag.title]
                    tag.title = editbox.value
                e.target.style.display = 'inline-block'
                e.target.parentNode.removeChild(editbox)
                tag.update()
                editor.focus()
            editbox.onblur = rename_tab
            editbox.onkeyup = def(e):
                if e.keyCode==13: # Enter
                    editor.focus()
                if e.keyCode==27: # Esc
                    editbox.value = tag.title
                    editor.focus()
            e.target.parentNode.insertBefore(editbox, e.target)
            editbox.focus()
            if tag.title.indexOf('.') > 0:
                editbox.setSelectionRange(0, tag.title.indexOf('.'))
            else:
                editbox.select()
    tag.switchtab = switchtab

    def closetab(e):
        if len(window.files) > 1:
            file = tag.title
            index = list(window.files).index(file)
            del window.files[file]
            if '__stdlib__/' + file in RapydScript.file_data:
                del RapydScript.file_data['__stdlib__/' + file]
            if index > 0:
                index = index - 1
            tag.title = list(window.files)[index]
            editor.setSession(window.files[tag.title])
            tag.update()
            editor.focus()
    tag.closetab = closetab

    def get_new_untitled(file='untitled.pyj'):
        basename = file.substr(0, file.indexOf('.'))
        extension = file.substr(file.indexOf('.'))
        i = 1
        while file in files:
            file = basename + "-" + i + extension
            i = i + 1
        return file

    def newtab(e):
        file = get_new_untitled()
        new_session = ace.createEditSession('')
        new_session.setNewLineMode("unix");
        new_session.setMode("ace/mode/python")
        window.files[file] = new_session
        editor.setSession(new_session)
        editor.focus()
        tag.title = file
        tag.update()
    tag.newtab = newtab

    def toggle_tray(show=False):
        if show==True or getComputedStyle(iframe).display == 'none':
            iframe.style.display='block'
            iframe.style.width='100%'
            event_bus.trigger("traybutton-close")
        else:
            iframe.style.display='none'
            event_bus.trigger("traybutton-open")
        editor.resize()
    event_bus.on("toggle-tray", toggle_tray)
    this.refs.hr.onclick = toggle_tray

    def run():
        if window.activity:
            event_bus.trigger("activity-save", activity)
        toggle_tray(True)
        js_output = compile()
        script = iframe.contentDocument.createElement('script')
        script.innerHTML = js_output
        def write_script():
            iframe.contentDocument.body.appendChild(script)
            iframe.contentDocument.close()
        iframe.onload = write_script
        iframe.contentWindow.location = 'template.html'
        return iframe
    event_bus.on("run-code", run)

    def break_code():
        iwindow = iframe.contentWindow
        # Set a fake timeout to get the highest timeout id
        highestTimeoutId = iwindow.setTimeout(';')
        for i in range(0, highestTimeoutId):
            iwindow.clearTimeout(i)
        highestIntervalId = iwindow.setInterval(';')
        for i in range(0, highestIntervalId):
            iwindow.clearInterval(i)
        iwindow.stop()
        iwindow.setTimeout(def():
            v'debugger'
        )
    event_bus.on("break-code", break_code)

    def clear_output():
        iframe.contentWindow.location = 'about:blank'
    event_bus.on("clear-output", clear_output)

    def serialize():
        result = {}
        for file in window.files:
            result[file] = window.files[file].getValue()
        return JSON.stringify(result)

    def save(activity):
        datastore = activity.getDatastoreObject()
        datastore.setDataAsText(serialize())
        def check_save(error):
            if error is None:
                console.log("Saved")
            else:
                console.log("NOT Saved")
        datastore.save(check_save)
    event_bus.on("activity-save", save)

    def example_load(file):
        if file in window.files:
            tag.title = file
            editor.setSession(window.files[file])
            tag.update()
            editor.focus()
            return
        url_base = window.location.protocol
        fetch(url_base + 'examples/' + file).then(
            def(response):
                if (response.ok or response.status==0):
                    response.text().then(def(data):
                        decoded = decodeURIComponent(data)
                        new_session = ace.createEditSession(decoded)
                        new_session.setNewLineMode("unix");
                        new_session.setMode("ace/mode/python")
                        files[file] = new_session
                        editor.setSession(new_session)
                        tag.title = file
                        tag.update()
                        editor.focus()
                    )
                else:
                    error = new Error(response.statusText)
                    error.response = response
                    raise error
        )
    event_bus.on("example-load", example_load)

    def run_full():
        code_editor = tag.refs.split
        code_editor.style.display = 'none'
        toolbar = document.getElementById('main-toolbar')
        toolbar.style.display = 'none'
        iframe = run()

        def restore(e):
            code_editor.style.display = 'flex'
            toolbar.style.display = 'flex'
            e.target.parentNode.removeChild(e.target)
            iframe.removeEventListener('load', add_restore_button)

        def add_restore_button():
            restore_button = iframe.contentDocument.createElement('button')
            restore_button.onclick = restore
            restore_button.style.opacity = '0.5'
            restore_button.style.position = 'fixed'
            restore_button.style.right = restore_button.style.top = '0'
            restore_button.style.padding = '0px'
            restore_button.style['background-image'] = 'url(icons/view-return.svg)'
            restore_button.style['background-repeat'] = 'no-repeat'
            restore_button.style['background-position'] = 'center'
            restore_button.style.width = restore_button.style.height = '55px'
            iframe.contentDocument.body.appendChild(restore_button)
        iframe.addEventListener('load', add_restore_button)
    event_bus.on("run-full", run_full)

    editor.commands.removeCommand('gotoline') # Conflicts with browser hotkey
    editor.commands.addCommand({
            'name': 'Run',
            'bindKey': {'win': 'Ctrl-Enter',  'mac': 'Command-Enter'},
            'exec': run})

    this.editor = editor
    window.editor = editor
    editor.focus()

this.on('mount', init)

</script>
</code-editor>
