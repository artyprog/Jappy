<tool-bar>
<style>
  #main-toolbar #run-button {
      background-image: url(icons/run_bw.svg);
  }
  #main-toolbar #run-button.colored {
      background-image: url(icons/run_color.svg);
  }
  #main-toolbar #break-button {
      background-image: url(icons/stopit_bw.svg);
  }
  #main-toolbar #break-button.colored {
      background-image: url(icons/stopit_color.svg);
  }
  #main-toolbar #erase-button {
      background-image: url(icons/eraser_bw.svg);
  }
  #main-toolbar #erase-button.colored {
      background-image: url(icons/eraser_color.svg);
  }
  #main-toolbar #example-button {
      background-image: url(icons/load-example.svg);
  }
  #main-toolbar #workspace-button {
      background-image: url(icons/user-documents.svg);
  }
  #main-toolbar #start-button {
      background-image: url(icons/activity-start.svg);
  }
  #main-toolbar #full-button {
      background-image: url(icons/view-fullscreen.svg);
  }
  #main-toolbar #export-button {
      background-image: url(icons/export-or-publish.svg);
  }
  .hidden {
      display: none !important;
  }
  .toolbutton:disabled {
      opacity: 0.5;
  }
</style>

<div id="main-toolbar" class="toolbar">
  <button class="toolbutton" id="activity-button" title="Jappy Activity"></button>

  <hr />
  <button class="toolbutton" id="example-button" title="Load an example" ref="examplebutton"></button>

  <button show={ location.hash } class="toolbutton" id="workspace-button" title="Workspace" ref="workspacebutton"></button>
  <hr />

  <button class="toolbutton { colored: window.state!='run' }" id="run-button" title="Execute" ref="runbutton" disabled></button>

  <button class="toolbutton { colored: window.state=='run' }" id="break-button" title="Break execution" ref="breakbutton"></button>

  <button class="toolbutton { colored: window.state!='clean' }" id="erase-button" title="Clear the canvas" ref="erasebutton"></button>

  <button class="toolbutton { hidden: window.state=='run' }" id="start-button" title="Start fullscreen" ref="startbutton" disabled></button>

  <button class="toolbutton { hidden: window.state=='stopped' } { hidden: window.state=='clean' }" id="full-button" title="View fullscreen" ref="fullbutton"></button>

  <button class="toolbutton" id="export-button" title="Export or publish" ref="exportbutton"></button>

  <button class="toolbutton pull-right" id="stop-button" title="Stop" ref="stopbutton"></button>
</div>

<script type="text/Rapyd">

from elementmaker import E
tag = this
url_base = location.protocol
address = url_base + '//' + location.host + '/dav'
if location.hash:
    window.fs = new WebDAV.Fs(address)

examples = ['welcome.pyj', 'memorize.pyj', 'mandala.pyj', 'input.pyj', 'repl.pyj', 'unicode.pyj']
window.state = 'clean'

def enable_run():
    tag.refs.runbutton.disabled = False
    tag.refs.startbutton.disabled = False
event_bus.on('compiler-ready', enable_run)

def filter_latest(files):
    ''' This will check files and try to determine by modification time
    that they were saved together. It's a "clever" and likely broken way
    to avoid otherwise coding metadata to record session of open files, 
    etc.
    '''
    files.sort(def(a,b): # Latest first
                   if a.mtime > b.mtime:
                       return -1
                   else:
                       return 1
                  )
    return files.reduce(def(result, item):
            prev = result[0]
            if item.name[0]=='.':
                return result
            elif prev is undefined:
                return result.concat(item)
            elif item.mtime.getTime() is prev.mtime.getTime():
                return result.concat(item)
            else:
                ''' We filter out those that don't have the same mtime
                as the first entry.'''
                return result
        , [])

def restore_last_session():
    if location.hash:
        url_base = location.protocol
        address = url_base + '//' + location.host + '/dav'
        if window.fs is undefined:
            window.fs = new WebDAV.Fs(address)

        path = location.hash.slice(1)
        def got_files(files):
            window.server_files = files
            recent_files = filter_latest(files)
            for item in recent_files:
                window.fs.file('/' + path + '/' + item.name).read(def(data):
                        event_bus.trigger('new-from-data', data, item.name, True)
                )
        if window.server_files is not undefined:
            got_files(window.server_files)
        else:
            fs.dir('/' + path).children(got_files)
event_bus.on("collaboration-ready", restore_last_session)

def load_file(ev):
    tag.workspace_palette.popDown()
    target_file = ev.target.getAttribute('data-uri')
    path = location.hash.slice(1)
    fs.file('/' + path + '/' + target_file).read(def(data):
            event_bus.trigger('new-from-data', data, target_file, True)
    )

def update_workspace_menu():
    if window.fs is undefined:
        return
    path = location.hash.slice(1)
    def list_files(found_files):
        window.server_files = found_files
        found_files.sort(def(a,b): # Latest first
                       if a.mtime > b.mtime:
                           return -1
                       else:
                           return 1
                      )
        items = []
        palette = tag.workspace_palette.getPalette()
        container = palette.getElementsByClassName('container')[0]
        container.innerHTML = ''
        for file in found_files:
            if file.name[0]=='.':
                continue
            row = document.createElement('div')
            row.classList.add('menu')
            item = document.createElement('button')
            item.classList.add('icon')
            span = document.createElement('span')
            span.classList.add('pyj')
            text = document.createTextNode(str(file.name))
            item.appendChild(span)
            item.appendChild(text)
            item.setAttribute('data-uri', file.name)
            item.addEventListener('click', load_file)
            row.appendChild(item)
            items.append(row)
        items.append(E.hr(class_='header-separator'))
        browse_button = E.button(class_='icon', E.span(class_='folder'), 'Browse...')
        browse_button.onclick = def():
            tag.workspace_palette.popDown()
            window.open('dav://' + location.host + '/dav/' + path)
        lastrow = E.div(class_='menu', browse_button)
        items.append(lastrow)
        tag.workspace_palette.setContent(items)
    def try_make_dir(body, existed_previously):
        fs.dir('/' + path).children(list_files)
    fs.dir('/' + path).mkdir(try_make_dir)
tag.update_workspace_menu = update_workspace_menu
event_bus.on("update-workspace-menu", update_workspace_menu)
event_bus.on("file-event", update_workspace_menu)

def init():

    this.refs.runbutton.onclick = def():
        window.state = 'run'
        tag.update()
        event_bus.trigger("run-code")
    this.refs.startbutton.onclick = def():
        window.state = 'run'
        tag.update()
        event_bus.trigger("run-fullscreen")
    this.refs.fullbutton.onclick = def():
        window.state = 'run'
        tag.update()
        event_bus.trigger("run-fullscreen", False)
    this.refs.breakbutton.onclick = def():
        window.state = 'stopped'
        tag.update()
        event_bus.trigger("break-code")
    this.refs.erasebutton.onclick = def():
        window.state = 'clean'
        event_bus.trigger("traybutton-close", False)
        tag.update()
        event_bus.trigger("clear-output")

    def activity_ready(activity):
        tag.refs.stopbutton.onclick = def():
            event_bus.trigger("activity-save", activity)
    event_bus.on("activity-ready", activity_ready)

    def enable_standalone():
        tag.refs.stopbutton.onclick = def():
            event_bus.trigger("activity-save", activity)
            base_url = location.protocol + '//' + location.host + '/'
            fetch (base_url + "shutdown")
    event_bus.on("enable-standalone", enable_standalone)

    require(["sugar-web/graphics/palette"],
        def(palette):
            tag.example_palette = new palette.Palette(tag.refs.examplebutton, 'Load an example')
            items = []
            for i in examples:
                row = document.createElement('div')
                row.classList.add('menu')
                item = document.createElement('button')
                item.classList.add('icon')
                span = document.createElement('span')
                span.classList.add('pyj')
                text = document.createTextNode(i)
                item.appendChild(span)
                item.appendChild(text)
                def trigger_load(el):
                    return def():
                        tag.example_palette.popDown()
                        event_bus.trigger('example-load', el)
                item.onclick = trigger_load(i)
                row.appendChild(item)
                items.append(row)
            tag.example_palette.setContent(items)

            tag.workspace_palette = new palette.Palette(tag.refs.workspacebutton, 'Workspace')
            update_workspace_menu()

            tag.export_palette = new palette.Palette(tag.refs.exportbutton, 'Export')
            class as_zip:
                label = 'Export as zipped HTML'
                icon = 'html'
                trigger = 'save-as-zip'
            class import_file:
                label = 'Import'
                icon = 'zip'
                trigger = 'import-file'
            items = []
            for i in [as_zip(), import_file()]:
                row = document.createElement('div')
                row.classList.add('menu')
                item = document.createElement('button')
                item.classList.add('icon')
                span = document.createElement('span')
                span.classList.add(i.icon)
                text = document.createTextNode(i.label)
                item.appendChild(span)
                item.appendChild(text)
                def trigger_export(event):
                    return def():
                        tag.export_palette.popDown()
                        event_bus.trigger(event)
                item.onclick = trigger_export(i.trigger)
                row.appendChild(item)
                items.append(row)
            tag.export_palette.setContent(items)
        )
this.on('mount', init)

</script>
</tool-bar>
